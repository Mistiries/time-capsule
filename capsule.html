<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Achraf and Eleni's Time Capsule</title>
<style>
body {
  margin: 0;
  padding: 0;
  background: black;
  font-family: sans-serif;
  overflow: hidden;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: url('images/backgroundwall.webp') no-repeat center center fixed;
  background-size: cover;
  opacity: 0;
  transition: opacity 3s ease-in;
  z-index: -1;
}

body.loaded::before {
  opacity: 1;
}

#container {
  opacity: 0;
  transition: opacity 3s ease-in;
  position: relative;
  width: 100%;
  height: 100vh;
}
#container.visible {
  opacity: 1;
}

#containerBlur {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  backdrop-filter: blur(8px);
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: none;
  z-index: 2500;
}

#containerBlur.active {
  opacity: 1;
}

.draggable {
  position: absolute;
  cursor: grab;
  user-select: none;
  padding: 8px;
  background: rgba(255,255,255,0.85);
  border-radius: 10px;
  box-shadow: 3px 3px 10px rgba(0,0,0,0.5);
  min-width: 120px;
  max-width: 200px;
  transition: transform 0.2s ease;
}

.draggable img {
  width: 100%;
  display: block;
  border-radius: 0;
}

.draggable.pure-item {
  background: transparent !important;
  padding: 0 !important;
  min-width: 0 !important;
  max-width: none !important;
  box-shadow: none !important;
}

.draggable img.pure {
  width: 150px;
  display: block;
  border-radius: 0;
}

.draggable p {
  margin: 5px 0 0 0;
  font-size: 14px;
}

.draggable.small-tab {
  max-width: 176px;
  min-width: 110px;
  padding: 7px;
}

.draggable.small-tab p {
  font-size: 12px;
}

.draggable.editable-tab {
  cursor: default;
  padding: 10px;
}

.draggable.editable-tab p {
  outline: none;
  min-height: 18px;
  cursor: text;
}

#muteBtn {
  position: fixed;
  top: 10px;
  right: 10px;
  z-index: 2002;
  padding: 8px 12px;
  background: rgba(255,255,255,0.85);
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  box-shadow: 2px 2px 6px rgba(0,0,0,0.5);
}

#tray {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 25%;
  transform: translateY(100%);
  background: rgba(240,240,240,0.9);
  border-top-left-radius: 20px;
  border-top-right-radius: 20px;
  box-shadow: 0 -3px 10px rgba(0,0,0,0.3);
  transition: transform 0.5s ease;
  z-index: 2001;
  display: flex;
  justify-content: flex-start;
  align-items: flex-start;
  padding: 10px;
  overflow: visible;
}

#tray.open {
  transform: translateY(0);
}

#trayTab {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 60px;
  height: 25px;
  background: rgba(200,200,200,0.9);
  border-top-left-radius: 15px;
  border-top-right-radius: 15px;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  font-weight: bold;
  box-shadow: 0 -2px 5px rgba(0,0,0,0.3);
  z-index: 2001;
}

#trayItems {
  position: relative;
  width: 100%;
  height: 100%;
}

/* Dark Mode Overlay */
#darkModeOverlay {
  position: fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background-color: rgba(0,0,0,0.55);
  pointer-events:none;
  opacity:0;
  transition: opacity 0.3s ease;
  z-index: 2600;
}

#darkModeOverlay.active {
  opacity: 1;
  pointer-events: auto;
}

/* Burger Menu */
#burgerMenu {
  position: fixed;
  top: 50%;
  left: 0;
  transform: translateY(-50%);
  width: 36px;
  height: 36px;
  background: white;
  border-radius: 5px;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  z-index: 3010;
}

#burgerMenuContent {
  position: fixed;
  top: 50%;
  left: -220px;
  transform: translateY(-50%);
  width: 200px;
  background: rgba(255,255,255,0.95);
  transition: left 0.3s ease;
  display: flex;
  flex-direction: column;
  padding: 20px;
  box-sizing: border-box;
  z-index: 3009;
  border-radius: 10px;
  box-shadow: 2px 2px 10px rgba(0,0,0,0.3);
}

#burgerMenuContent.open {
  left: 10px;
}

#burgerMenuContent button {
  margin: 10px 0;
  padding: 8px;
  cursor:pointer;
  background:white;
  border:none;
  box-shadow: 0 0 5px rgba(0,0,0,0.3);
  font-size: 16px;
  transition: transform 0.1s ease;
  border-radius: 5px;
}

#burgerMenuContent button:active {
  transform: scale(0.95);
}

#instructionsBtn {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

#cloudsBtn {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Trash bin */
#trashBin {
  position: fixed;
  bottom: 5%;
  right: 5%;
  font-size: 48px;
  cursor: pointer;
  z-index: 2000;
  transition: transform 0.1s ease;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

#trashBin.shake {
  animation: shake 0.3s ease;
}

/* Table */
#table {
  position: fixed;
  bottom: 10%;
  right: 12%;
  width: 234px;
  cursor: default;
  z-index: 400;
}

/* Envelope */
#envelope {
  position: fixed;
  bottom: 26%;
  right: 22%;
  width: 100px;
  cursor: pointer;
  z-index: 451;
  transition: transform 0.1s ease;
}

#envelope:active {
  transform: scale(0.95);
}

/* Letter images */
.letter-img {
  position: absolute;
  width: 150px;
  cursor: grab;
  user-select: none;
  box-shadow: 2px 2px 6px rgba(0,0,0,0.3);
  transition: transform 0.2s ease;
  z-index: 455;
}

/* Viewer animations */
@keyframes popIn {
  0% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.9);
  }
  100% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
}

/* Image viewer */
#imageViewer {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.9);
  max-width: 80vw;
  max-height: 70vh;
  z-index: 3500;
  display: none;
  opacity: 0;
}

#imageViewer.visible {
  display: block;
  animation: popIn 0.2s ease forwards;
}

#imageViewer img {
  max-width: 100%;
  max-height: 60vh;
  display: block;
  box-shadow: 3px 3px 10px rgba(0,0,0,0.5);
}

#imageViewer .escape-note {
  background: white;
  padding: 10px;
  text-align: center;
  font-size: 14px;
  color: #666;
  margin-top: 10px;
  border-radius: 5px;
  box-shadow: 2px 2px 6px rgba(0,0,0,0.3);
}

/* Letter viewer */
#letterViewer {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.9);
  width: 600px;
  max-height: 80vh;
  background: white;
  padding: 40px;
  border-radius: 10px;
  box-shadow: 3px 3px 10px rgba(0,0,0,0.5);
  z-index: 3500;
  display: none;
  opacity: 0;
  overflow-y: auto;
}

#letterViewer.visible {
  display: block;
  animation: popIn 0.2s ease forwards;
}

#letterViewer .letter-content {
  font-family: 'Comic Sans MS', 'Segoe Print', cursive;
  font-size: 18px;
  line-height: 1.6;
  margin-bottom: 20px;
}

#letterViewer .letter-nav {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  padding: 10px;
  border-top: 1px solid #ddd;
  margin-top: 20px;
}

#letterViewer .letter-nav button {
  background: white;
  border: 1px solid #ccc;
  padding: 8px 16px;
  cursor: pointer;
  border-radius: 5px;
  font-size: 20px;
}

#letterViewer .letter-nav button:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

#letterViewer .escape-note {
  text-align: center;
  font-size: 14px;
  color: #666;
}

/* Tooltip */
#tooltip {
  position: fixed;
  pointer-events: none;
  padding: 3px 6px;
  font-size: 16px;
  background: rgba(0,0,0,0.6);
  color: white;
  border-radius: 4px;
  opacity: 0;
  transition: opacity 0.2s ease;
  z-index: 3000;
}

/* Instructions Paper */
#instructionsPaper {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.9);
  width: 500px;
  max-height: 80vh;
  overflow-y: auto;
  background: white;
  padding: 40px;
  border-radius: 10px;
  box-shadow: 3px 3px 10px rgba(0,0,0,0.5);
  z-index: 3500;
  display: none;
  opacity: 0;
  font-family: 'Comic Sans MS', 'Segoe Print', cursive;
}

#instructionsPaper.visible {
  display: block;
  animation: popIn 0.2s ease forwards;
}

#instructionsPaper h1 {
  font-family: 'Comic Sans MS', 'Segoe Print', cursive;
  font-size: 36px;
  margin: 0 0 5px 0;
  text-align: center;
}

#instructionsPaper .subtitle {
  text-align: center;
  font-size: 14px;
  color: #666;
  margin-bottom: 25px;
  font-style: italic;
}

#instructionsPaper ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

#instructionsPaper li {
  margin: 12px 0;
  padding-left: 25px;
  position: relative;
  font-size: 18px;
  line-height: 1.5;
}

#instructionsPaper li:before {
  content: "‚Ä¢";
  position: absolute;
  left: 0;
  font-size: 20px;
}

/* Headphones text */
#headphonesText {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.8);
  font-family: 'Brush Script MT', cursive;
  font-style: italic;
  font-size: 32px;
  color: white;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
  opacity: 0;
  transition: opacity 1s ease-in-out, transform 1s ease-in-out;
  z-index: 6000;
  pointer-events: none;
}

#headphonesText.visible {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
}

#headphonesText.hidden {
  opacity: 0;
  transform: translate(-50%, -50%) scale(1);
}

/* Cloud viewer */
#cloudViewer {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 3500;
  display: none;
  overflow: hidden;
}

#cloudViewer.visible {
  display: block;
}

.cloud {
  position: absolute;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 50px;
  padding: 20px 30px;
  font-family: 'Times New Roman', serif;
  font-size: 16px;
  text-align: center;
  box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
  user-select: none;
  max-width: 250px;
  pointer-events: none;
}

#cloudEscapeNote {
  position: fixed;
  bottom: 10px;
  left: 10px;
  background: rgba(255, 255, 255, 0.7);
  padding: 8px 15px;
  border-radius: 5px;
  box-shadow: 2px 2px 6px rgba(0,0,0,0.3);
  font-size: 13px;
  color: #666;
  z-index: 3501;
  display: none;
}

#cloudViewer.visible #cloudEscapeNote {
  display: block;
}
</style>
</head>
<body>
<div id="container">
  <audio id="pickup" src="sounds/pickup.mp3"></audio>
  <audio id="background" src="sounds/background.mp3" loop></audio>
  <audio id="background2" src="sounds/background2.mp3" loop></audio>
  <audio id="background3" src="sounds/background3.mp3" loop></audio>
  <audio id="binSound" src="sounds/bin.mp3"></audio>
  <audio id="traySound" src="sounds/tray.mp3"></audio>
  <audio id="paperSound" src="sounds/paper.mp3"></audio>
  <audio id="paper2Sound" src="sounds/paper2.mp3"></audio>

  <button id="muteBtn">Mute Music</button>

  <!-- Memory tabs -->
  <div class="draggable" style="top:20px; left:20px; z-index:400;">
    <p>This is our time capsule. It reminds us of what is and has been.</p>
  </div>
  <div class="draggable" style="top:100px; left:20px; z-index:400;">
    <p>Created on the 12th December, 2025.</p>
  </div>
  <div class="draggable small-tab" style="top:200px; left:900px; z-index:400;">
    <p>I don't want another timeline that doesn't have you in it</p>
  </div>
  <div class="draggable small-tab" style="top:320px; left:100px; z-index:400;">
    <p>"I love how we just bump each others egos. I will always bump your ego to the sky, and you will do the same to me."</p>
  </div>
  <div class="draggable small-tab" style="top:120px; left:550px; z-index:400;">
    <p>you can decorate this space with the tray items!</p>
  </div>
  <div class="draggable small-tab editable-tab" style="top:420px; left:200px; z-index:400;">
    <p contenteditable="true" data-placeholder="you can type in this box">you can type in this box</p>
  </div>

  <div id="headphonesText">Headphones recommended</div>
  
  <div id="containerBlur"></div>
  <div id="darkModeOverlay"></div>

  <div id="tray">
    <div id="trayItems">
      <div class="draggable pure-item" style="top:10px; left:20px;">
        <img src="images/peachtea.webp" alt="Peach Tea" class="pure">
      </div>
      <div class="draggable pure-item" style="top:10px; left:130px; transform: rotate(-3deg);">
        <img src="images/laces.png" alt="Laces" class="pure" style="width:135px;">
      </div>
      <div class="draggable pure-item" style="top:10px; left:235px;">
        <img src="images/sliders.webp" alt="Sliders" class="pure">
      </div>
      <div class="draggable pure-item" style="top:10px; left:355px;">
        <img src="images/badminton.webp" alt="Badminton" class="pure">
      </div>
      <div class="draggable pure-item" style="top:15px; left:455px; transform: rotate(5deg);">
        <img src="images/hornet.png" alt="Hornet" class="pure">
      </div>
      <div class="draggable pure-item" style="top:10px; left:515px;">
        <img src="images/hollowknight.png" alt="Hollow Knight" class="pure">
      </div>
      <div class="draggable pure-item" style="top:10px; left:625px;">
        <img src="images/robin.png" alt="Robin" class="pure" style="width:135px;">
      </div>
      <div class="draggable pure-item" style="top:10px; left:750px;">
        <img src="images/lethal.webp" alt="Lethal" class="pure" style="width:120px;">
      </div>
    </div>
  </div>

  <div id="trayTab">‚ñ≤</div>

  <div id="burgerMenu">‚ò∞</div>
  <div id="burgerMenuContent">
    <div id="musicControls" style="display:flex;justify-content:center;gap:10px;">
      <button id="prevTrack">‚èÆ</button>
      <button id="nextTrack">‚è≠</button>
    </div>
    <button id="instructionsBtn">üìã</button>
    <button id="cloudsBtn">‚òÅÔ∏è</button>
  </div>

  <div id="trashBin">üóëÔ∏è</div>

  <!-- Table -->
  <img src="images/table.webp" id="table">
  
  <!-- Envelope -->
  <img src="images/envelope.webp" id="envelope">

  <!-- Desk images -->
  <div class="draggable pure-item" style="top:10%; left:32%;">
    <img src="images/image2.jpg" alt="Memory 2" class="pure" style="width:144px;">
  </div>
  <div class="draggable pure-item" style="top:10%; left:32%; transform: rotate(-8deg);">
    <img src="images/image1.jpg" alt="Memory 1" class="pure" style="width:144px;">
  </div>
  <div class="draggable pure-item" style="top:400px; left:350px;">
    <img src="images/sticker1.jpg" alt="Sticker" class="pure" style="width:114px;">
  </div>
  
  <!-- Cat and Computer -->
  <div class="draggable pure-item" style="top:5%; left:75%;">
    <img src="images/cat.jpg" alt="Cat" class="pure" style="width:144px;">
  </div>
  <div class="draggable pure-item" style="top:58%; left:48%;">
    <img src="images/computer.jpg" alt="Computer" class="pure" style="width:150px;">
  </div>
  
  <!-- Bean bag -->
  <div class="draggable pure-item" style="bottom:2%; left:3%;">
    <img src="images/bean.png" alt="Bean Bag" class="pure" style="width:180px;">
  </div>
  
  <!-- Page -->
  <div class="draggable pure-item" style="top:250px; left:450px;">
    <img src="images/page.webp" alt="Page" class="pure" id="pageItem">
  </div>

  <div id="tooltip"></div>

  <div id="instructionsPaper">
    <h1>Instructions</h1>
    <p class="subtitle">(click anywhere to escape)</p>
    <ul>
      <li>Drag any item around (apart from some)</li>
      <li>Pull open the tray to find more items and store items</li>
      <li>Pull items to the bin to get rid of them</li>
      <li>Reload the page to reset everything</li>
      <li>Use the music player in left menu to change music</li>
      <li>Hover over items to see notes</li>
      <li>Click the envelope to open it, and click again to tidy up</li>
      <li>Click on images to view them</li>
      <li>Click the page to view the letter</li>
      <li>In the ‚òÅÔ∏è, there are floating clouds with things I want written on them</li>
    </ul>
  </div>

  <div id="imageViewer">
    <img id="viewerImg" src="">
    <div class="escape-note">Click anywhere to escape</div>
  </div>
  
  <div id="letterViewer">
    <div class="letter-content" id="letterContent"></div>
    <div class="letter-nav">
      <button id="prevPage">‚Üê</button>
      <span class="escape-note">Click anywhere to escape</span>
      <button id="nextPage">‚Üí</button>
    </div>
  </div>

  <div id="cloudViewer">
    <div id="cloudEscapeNote">Click anywhere to escape</div>
  </div>
</div>

<script>
const pickupSound = document.getElementById('pickup');
const muteBtn = document.getElementById('muteBtn');
const container = document.getElementById('container');
const tray = document.getElementById('tray');
const trayItems = document.getElementById('trayItems');
const trayTab = document.getElementById('trayTab');
const darkOverlay = document.getElementById('darkModeOverlay');
const burgerMenu = document.getElementById('burgerMenu');
const burgerContent = document.getElementById('burgerMenuContent');
const trashBin = document.getElementById('trashBin');
const binSound = document.getElementById('binSound');
const traySound = document.getElementById('traySound');
const paperSound = document.getElementById('paperSound');
paperSound.volume = 0.6;
const paper2Sound = document.getElementById('paper2Sound');
paper2Sound.volume = 0.2;
const tooltip = document.getElementById('tooltip');
const instructionsPaper = document.getElementById('instructionsPaper');
const imageViewer = document.getElementById('imageViewer');
const viewerImg = document.getElementById('viewerImg');
const letterViewer = document.getElementById('letterViewer');
const letterContent = document.getElementById('letterContent');
const pageItem = document.getElementById('pageItem');
const headphonesText = document.getElementById('headphonesText');
const containerBlur = document.getElementById('containerBlur');
const cloudViewer = document.getElementById('cloudViewer');
let isViewerOpen = false;
let currentLetterPage = 0;
let clouds = [];
let animationFrameId = null;
let musicStarted = false;

const letterPages = [
  "I know this is quite a simple website, compared to what you can do, this must be like a mountain looking at a stone. However, I'm proud of it üò≠ and I learnt quite a lot when I put it together. I liked looking into the code and seeing new language, and guessing which part did what.",
  "I never knew I was capable of this. Not just this website, I mean, having an online friend. I was always afraid of people online because the ones I talked to were literal monkeys, and they weren't always nice. I didn't know that it was possible to have such a good friend online, but there's a first time for everything!",
  "I feel sad that the letter I sent you has decided to vanish into the voids (for now), but making this made me feel better. Maybe you can suggest some ideas for this place? I want it to be both of ours, not just something I made. I hope you like it, even if it is simple."
];

function updateLetterPage() {
  letterContent.textContent = letterPages[currentLetterPage];
  document.getElementById('prevPage').disabled = currentLetterPage === 0;
  document.getElementById('nextPage').disabled = currentLetterPage === letterPages.length - 1;
}

document.getElementById('prevPage').addEventListener('click', (e) => {
  e.stopPropagation();
  if(currentLetterPage > 0) {
    currentLetterPage--;
    updateLetterPage();
    paper2Sound.currentTime = 0;
    paper2Sound.play();
  }
});

document.getElementById('nextPage').addEventListener('click', (e) => {
  e.stopPropagation();
  if(currentLetterPage < letterPages.length - 1) {
    currentLetterPage++;
    updateLetterPage();
    paper2Sound.currentTime = 0;
    paper2Sound.play();
  }
});

// Music
const musicTracks = [document.getElementById('background'), document.getElementById('background2'), document.getElementById('background3')];
let currentTrack = 0;
musicTracks.forEach(track => { track.volume=0.6; });

function startMusic() {
  if(!musicStarted) {
    musicTracks[currentTrack].play().then(() => {
      musicStarted = true;
    }).catch(err => {
      console.log('Music autoplay blocked, waiting for user interaction');
    });
  }
}

document.getElementById('nextTrack').addEventListener('click', (e)=>{ 
  e.stopPropagation();
  startMusic();
  fadeOutInTrack(1); 
});
document.getElementById('prevTrack').addEventListener('click', (e)=>{ 
  e.stopPropagation();
  startMusic();
  fadeOutInTrack(-1); 
});

function fadeOutInTrack(direction){
  let current = musicTracks[currentTrack];
  let nextIndex = (currentTrack + direction + musicTracks.length) % musicTracks.length;
  let next = musicTracks[nextIndex];
  let fadeOut = setInterval(()=>{ if(current.volume>0.05){ current.volume -=0.05; } else { clearInterval(fadeOut); current.pause(); current.currentTime=0; next.volume=0; next.play(); fadeIn(next); currentTrack=nextIndex; } },50);
}

function fadeIn(track){
  let fadeIn = setInterval(()=>{ if(track.volume<0.6){ track.volume +=0.05; } else { clearInterval(fadeIn); } },50);
}

// Tooltip
function setupTooltip(img,text){
  let timeout;
  img.addEventListener('mouseenter',()=>{ timeout=setTimeout(()=>{ tooltip.textContent=text; tooltip.style.opacity=1; },250); });
  img.addEventListener('mouseleave',()=>{ clearTimeout(timeout); tooltip.style.opacity=0; });
  img.addEventListener('mousedown',()=>{ clearTimeout(timeout); tooltip.style.opacity=0; });
  img.addEventListener('mousemove',(e)=>{ tooltip.style.left=(e.clientX+15)+'px'; tooltip.style.top=(e.clientY+15)+'px'; });
}

// Setup tooltips
const trayItemImgs = document.querySelectorAll('.pure-item img.pure');
setupTooltip(trayItemImgs[0],'I love peach tea');
setupTooltip(trayItemImgs[1],'I ate these all the time as a child');
setupTooltip(trayItemImgs[2],'you prefer sliders over shoes any day');
setupTooltip(trayItemImgs[3],'badminton; my fav sport');
setupTooltip(trayItemImgs[4],'Shaw no more üíî');
setupTooltip(trayItemImgs[5],'Hornet figurine');
setupTooltip(trayItemImgs[6],'the game that started it all');
setupTooltip(trayItemImgs[7],'the one time we played lethal company');
setupTooltip(trayItemImgs[8],'the day you got my first letter');
setupTooltip(trayItemImgs[9],'the day you got my first letter');
setupTooltip(trayItemImgs[10],'us');
setupTooltip(trayItemImgs[11],'the cute cat that sat on your lap');
setupTooltip(trayItemImgs[12],'the day i made the photo collage on my laptop');
setupTooltip(trayItemImgs[13],'comfy bean bag');
setupTooltip(pageItem,'a letter');
setupTooltip(document.getElementById('table'),'a strong sturdy table');
setupTooltip(document.getElementById('envelope'),'an envelope full of texts');

function makeDraggable(item){
  let offsetX, offsetY, lastX=0, lastY=0;
  let isDragging = false;
  let dragStartTime = 0;
  let startX = 0, startY = 0;
  let hasPlayedPickupSound = false;
  
  const editableP = item.querySelector('p[contenteditable="true"]');
  const img = item.querySelector('img');
  const isClickableImage = img && (img.classList.contains('pure') && (img.alt === 'Memory 1' || img.alt === 'Memory 2' || img.alt === 'Cat' || img.alt === 'Computer' || img.alt === 'Sticker'));
  const isPageOrEnvelope = img && (img.id === 'pageItem');
  
  function handleStart(e){
    if(isViewerOpen) return;
    
    if(editableP && e.target === editableP) return;
    
    if(editableP) {
      const pRect = editableP.getBoundingClientRect();
      const clickX = e.clientX || (e.touches && e.touches[0].clientX);
      const clickY = e.clientY || (e.touches && e.touches[0].clientY);
      
      if(clickX >= pRect.left && clickX <= pRect.right && 
         clickY >= pRect.top && clickY <= pRect.bottom) {
        return;
      }
    }
    
    const touch = e.touches ? e.touches[0] : e;
    e.preventDefault();
    isDragging = false;
    dragStartTime = Date.now();
    hasPlayedPickupSound = false;
    
    startMusic();
    
    const rect = item.getBoundingClientRect();
    offsetX = touch.clientX - rect.left;
    offsetY = touch.clientY - rect.top;
    lastX = touch.clientX; 
    lastY = touch.clientY;
    startX = touch.clientX;
    startY = touch.clientY;
    
    const bodyRect = document.body.getBoundingClientRect();
    item.style.left = (rect.left - bodyRect.left)+'px';
    item.style.top = (rect.top - bodyRect.top)+'px';
    item.style.position = 'absolute';
    const originalZ = item.classList.contains('pure-item') ? '450' : '400';
    item.style.zIndex = '2100';
    item.dataset.originalZIndex = originalZ;
    item.style.transition="transform 0s";
    item.style.transform="scale(1) rotate(0deg)";
    if(item.parentElement!==document.body) document.body.appendChild(item);
    
    function handleMove(e){
      const touch = e.touches ? e.touches[0] : e;
      const dx = touch.clientX - lastX;
      const dy = touch.clientY - lastY;
      const totalDx = touch.clientX - startX;
      const totalDy = touch.clientY - startY;
      
      if(Math.abs(totalDx) > 3 || Math.abs(totalDy) > 3) {
        isDragging = true;
      }
      
      const swing = Math.min(Math.sqrt(dx*dx+dy*dy)*0.2,5);
      let scale=1.05;
      const binRect = trashBin.getBoundingClientRect();
      if(touch.clientX>=binRect.left && touch.clientX<=binRect.right && touch.clientY>=binRect.top && touch.clientY<=binRect.bottom){ 
        scale=0.85; 
      }
      item.style.transform=`rotate(${swing}deg) scale(${scale})`;
      item.style.left=(touch.clientX - offsetX)+'px';
      item.style.top=(touch.clientY - offsetY)+'px';
      lastX = touch.clientX; 
      lastY = touch.clientY;
    }
    
    function handleEnd(e){
      const touch = e.changedTouches ? e.changedTouches[0] : e;
      document.removeEventListener('mousemove',handleMove);
      document.removeEventListener('touchmove',handleMove);
      document.removeEventListener('mouseup', handleEnd);
      document.removeEventListener('touchend', handleEnd);
      
      item.style.transition="transform 0.2s ease";
      item.style.transform="scale(1) rotate(0deg)";
      
      const trayRect = tray.getBoundingClientRect();
      if(touch.clientY > trayRect.top && tray.classList.contains('open')){
        if(item.parentElement !== trayItems) {
          trayItems.appendChild(item);
        }
        const trayRectNew = trayItems.getBoundingClientRect();
        item.style.left=(touch.clientX - trayRectNew.left - offsetX)+'px';
        item.style.top=(touch.clientY - trayRectNew.top - offsetY)+'px';
      }
      
      item.style.zIndex = item.dataset.originalZIndex;
      
      const binRect = trashBin.getBoundingClientRect();
      if(touch.clientX>=binRect.left && touch.clientX<=binRect.right && touch.clientY>=binRect.top && touch.clientY<=binRect.bottom){
        binSound.currentTime=0; 
        binSound.play();
        trashBin.classList.add('shake');
        setTimeout(() => trashBin.classList.remove('shake'), 300);
        item.remove();
        return;
      }
      
      if(!isDragging && Date.now() - dragStartTime < 200 && !isViewerOpen){
        if(isClickableImage && !isPageOrEnvelope) {
          pickupSound.currentTime=0;
          pickupSound.play();
          item.style.transform = 'scale(0.95)';
          setTimeout(() => {
            item.style.transform = 'scale(1) rotate(0deg)';
          }, 100);
        }
        
        const img = item.querySelector('img');
        if(img && img.id === 'pageItem'){
          isViewerOpen = true;
          currentLetterPage = 0;
          updateLetterPage();
          paper2Sound.currentTime=0;
          paper2Sound.play();
          letterViewer.classList.add('visible');
          containerBlur.classList.add('active');
          darkOverlay.classList.add('active');
        } else if(img && item.classList.contains('letter-img')){
          isViewerOpen = true;
          viewerImg.src = img.src;
          imageViewer.classList.add('visible');
          containerBlur.classList.add('active');
          darkOverlay.classList.add('active');
        } else if(img && img.classList.contains('pure') && (img.alt === 'Memory 1' || img.alt === 'Memory 2' || img.alt === 'Cat' || img.alt === 'Computer' || img.alt === 'Sticker')){
          isViewerOpen = true;
          viewerImg.src = img.src;
          imageViewer.classList.add('visible');
          containerBlur.classList.add('active');
          darkOverlay.classList.add('active');
        }
      }
    }
    
    document.addEventListener('mousemove', handleMove);
    document.addEventListener('touchmove', handleMove, {passive: false});
    document.addEventListener('mouseup', handleEnd);
    document.addEventListener('touchend', handleEnd);
  }
  
  item.addEventListener('mousedown', handleStart);
  item.addEventListener('touchstart', handleStart, {passive: false});
  item.ondragstart=()=>false;
}

document.querySelectorAll('.draggable').forEach(makeDraggable);

// Editable tab handling
document.querySelectorAll('.editable-tab p[contenteditable="true"]').forEach(p => {
  p.addEventListener('focus', function() {
    if(this.textContent === this.dataset.placeholder) {
      this.textContent = '';
    }
  });
  
  p.addEventListener('blur', function() {
    if(this.textContent.trim() === '') {
      this.textContent = this.dataset.placeholder;
    }
  });
  
  p.addEventListener('click', function(e) {
    e.stopPropagation();
  });
});

// Envelope
let lettersOut = false;
let letterElements = [];
const letterFiles = ['text (1).jpg','text (2).jpg','text (3).jpg','text (4).jpg','text (5).jpg','text (6).jpg','text (7).jpg','text (9).jpg','text (10).jpg','text (11).jpg','text (12).jpg','text (13).jpg','text (14).jpg'];

document.getElementById('envelope').addEventListener('click', () => {
  if(isViewerOpen) return;
  startMusic();
  paperSound.currentTime = 0;
  paperSound.play();
  
  if (!lettersOut) {
    const envelopeRect = document.getElementById('envelope').getBoundingClientRect();
    letterFiles.forEach((file, index) => {
      const letterDiv = document.createElement('div');
      letterDiv.className = 'letter-img';
      const img = document.createElement('img');
      img.src = `images/letter/${file}`;
      img.style.width = '100%';
      letterDiv.appendChild(img);
      letterDiv.style.left = (envelopeRect.left - 120) + 'px';
      letterDiv.style.top = (envelopeRect.top - 50 + index * 2) + 'px';
      document.body.appendChild(letterDiv);
      letterElements.push(letterDiv);
      makeDraggable(letterDiv);
    });
    lettersOut = true;
  } else {
    letterElements.forEach(el => el.remove());
    letterElements = [];
    lettersOut = false;
  }
});

// Close viewers
function closeViewer() {
  isViewerOpen = false;
  instructionsPaper.classList.remove('visible');
  imageViewer.classList.remove('visible');
  letterViewer.classList.remove('visible');
  cloudViewer.classList.remove('visible');
  containerBlur.classList.remove('active');
  darkOverlay.classList.remove('active');
  if(animationFrameId) {
    cancelAnimationFrame(animationFrameId);
    animationFrameId = null;
  }
}

darkOverlay.addEventListener('click', closeViewer);
containerBlur.addEventListener('click', closeViewer);
cloudViewer.addEventListener('click', closeViewer);

// Close burger menu when clicking outside
document.addEventListener('click', (e) => {
  if(!burgerMenu.contains(e.target) && !burgerContent.contains(e.target)) {
    burgerContent.classList.remove('open');
  }
});

burgerMenu.addEventListener('click', (e) => {
  e.stopPropagation();
  startMusic();
  pickupSound.currentTime=0;
  pickupSound.play();
  
  if(burgerContent.classList.contains('open')) {
    burgerContent.classList.remove('open');
  } else {
    if(isViewerOpen) {
      closeViewer();
    }
    burgerContent.classList.add('open');
  }
});

burgerContent.addEventListener('click', (e) => {
  e.stopPropagation();
});

imageViewer.addEventListener('click', closeViewer);
letterViewer.addEventListener('click', (e) => {
  if(!e.target.closest('button')) {
    paper2Sound.currentTime=0;
    paper2Sound.play();
    closeViewer();
  }
});
instructionsPaper.addEventListener('click', closeViewer);

// Initial load
window.addEventListener('DOMContentLoaded', () => { 
  startMusic();
  
  requestAnimationFrame(() => {
    headphonesText.classList.add('visible');
  });
  
  setTimeout(() => {
    document.body.classList.add('loaded');
    container.classList.add('visible');
  }, 100);
  
  setTimeout(() => {
    headphonesText.classList.remove('visible');
    headphonesText.classList.add('hidden');
  }, 2500);
});

// Try to start music on any user interaction
document.addEventListener('click', startMusic, {once: true});
document.addEventListener('touchstart', startMusic, {once: true});
document.addEventListener('keydown', startMusic, {once: true});

muteBtn.addEventListener('click', () => {
  startMusic();
  musicTracks.forEach(track => track.muted = !track.muted);
  muteBtn.textContent = musicTracks[0].muted ? 'Unmute Music' : 'Mute Music';
});

trayTab.addEventListener('click', () => {
  startMusic();
  tray.classList.toggle('open');
  trayTab.textContent = tray.classList.contains('open') ? '‚ñº' : '‚ñ≤';
  traySound.currentTime=0;
  traySound.play();
});

document.getElementById('instructionsBtn').addEventListener('click', (e) => {
  e.stopPropagation();
  if(isViewerOpen) return;
  startMusic();
  isViewerOpen = true;
  paperSound.currentTime=0;
  paperSound.play();
  instructionsPaper.classList.add('visible');
  containerBlur.classList.add('active');
  darkOverlay.classList.add('active');
  burgerContent.classList.remove('open');
});

// Cloud viewer
const cloudTexts = [
  "I want to go to a restaurant with you",
  "I want to stay up late at night and have long conversations",
  "I want to show you the uk",
  "I want to bring you food from the uk you've never tried",
  "I want to die laughing with you",
  "I want to be there for you",
  "I want to listen to your problems",
  "I want to make you more letters",
  "I want to hear about what you find interesting",
  "I want to have deep conversations about everything",
  "I want to travel to come see you",
  "I want to make you laugh",
  "I want to see your smile"
];

function createClouds() {
  clouds = [];
  cloudViewer.innerHTML = '<div id="cloudEscapeNote">Click anywhere to escape</div>';
  
  cloudTexts.forEach((text, i) => {
    const cloud = document.createElement('div');
    cloud.className = 'cloud';
    cloud.textContent = text;
    cloud.style.left = Math.random() * (window.innerWidth - 300) + 50 + 'px';
    cloud.style.top = Math.random() * (window.innerHeight - 150) + 50 + 'px';
    cloudViewer.appendChild(cloud);
    
    const cloudData = {
      element: cloud,
      x: parseFloat(cloud.style.left),
      y: parseFloat(cloud.style.top),
      vx: (Math.random() - 0.5) * 1.2,
      vy: (Math.random() - 0.5) * 1.2,
      nextDirectionChange: Date.now() + 3000
    };
    
    clouds.push(cloudData);
  });
}

function animateClouds() {
  const now = Date.now();
  
  clouds.forEach((cloudData, i) => {
    if(now >= cloudData.nextDirectionChange) {
      cloudData.vx = (Math.random() - 0.5) * 1.2;
      cloudData.vy = (Math.random() - 0.5) * 1.2;
      cloudData.nextDirectionChange = now + 3000;
    }
    
    cloudData.x += cloudData.vx;
    cloudData.y += cloudData.vy;
    
    const rect = cloudData.element.getBoundingClientRect();
    const width = rect.width;
    const height = rect.height;
    
    if(cloudData.x <= 0) {
      cloudData.x = 1;
      cloudData.vx = Math.abs(cloudData.vx);
      cloudData.nextDirectionChange = now + 3000;
    }
    if(cloudData.x + width >= window.innerWidth) {
      cloudData.x = window.innerWidth - width - 1;
      cloudData.vx = -Math.abs(cloudData.vx);
      cloudData.nextDirectionChange = now + 3000;
    }
    if(cloudData.y <= 0) {
      cloudData.y = 1;
      cloudData.vy = Math.abs(cloudData.vy);
      cloudData.nextDirectionChange = now + 3000;
    }
    if(cloudData.y + height >= window.innerHeight) {
      cloudData.y = window.innerHeight - height - 1;
      cloudData.vy = -Math.abs(cloudData.vy);
      cloudData.nextDirectionChange = now + 3000;
    }
    
    clouds.forEach((other, j) => {
      if(i >= j) return;
      
      const otherRect = other.element.getBoundingClientRect();
      const dx = (cloudData.x + width/2) - (other.x + otherRect.width/2);
      const dy = (cloudData.y + height/2) - (other.y + otherRect.height/2);
      const distance = Math.sqrt(dx*dx + dy*dy);
      const minDist = (width + otherRect.width) / 2.5;
      
      if(distance < minDist) {
        const angle = Math.atan2(dy, dx);
        const overlap = minDist - distance;
        
        cloudData.x += Math.cos(angle) * overlap * 0.5;
        cloudData.y += Math.sin(angle) * overlap * 0.5;
        other.x -= Math.cos(angle) * overlap * 0.5;
        other.y -= Math.sin(angle) * overlap * 0.5;
        
        const tempVx = cloudData.vx;
        const tempVy = cloudData.vy;
        cloudData.vx = other.vx * 0.9;
        cloudData.vy = other.vy * 0.9;
        other.vx = tempVx * 0.9;
        other.vy = tempVy * 0.9;
      }
    });
    
    cloudData.element.style.left = cloudData.x + 'px';
    cloudData.element.style.top = cloudData.y + 'px';
  });
  
  if(cloudViewer.classList.contains('visible')) {
    animationFrameId = requestAnimationFrame(animateClouds);
  }
}

document.getElementById('cloudsBtn').addEventListener('click', (e) => {
  e.stopPropagation();
  if(isViewerOpen) return;
  startMusic();
  isViewerOpen = true;
  createClouds();
  cloudViewer.classList.add('visible');
  containerBlur.classList.add('active');
  darkOverlay.classList.add('active');
  burgerContent.classList.remove('open');
  animateClouds();
});
</script>
</body>
</html>
